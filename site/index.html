import sys
from PyQt5.QtWidgets import (
    QApplication, QMainWindow, QWidget, QVBoxLayout, QHBoxLayout,
    QLabel, QLineEdit, QPushButton, QMessageBox, QFrame, QInputDialog,
    QScrollArea
)
from PyQt5.QtCore import Qt

class BankApp(QMainWindow):
    def __init__(self):
        super().__init__()
        self.setWindowTitle("🏦 Secure Banking System")
        self.setGeometry(150, 100, 500, 550)

        # User and account details
        self.username = "admin"
        self.password = "1234"
        self.logged_in = False
        self.balance = 0
        self.history = []

        # Accounts for transfer
        self.accounts = {"Me": 0, "Friend": 0, "Family": 0}

        self.is_dark = False

        # Scrollable main container
        self.scroll = QScrollArea()
        self.scroll.setWidgetResizable(True)
        self.container = QWidget()
        self.scroll.setWidget(self.container)
        self.setCentralWidget(self.scroll)

        self.main_layout = QVBoxLayout(self.container)
        self.main_layout.setAlignment(Qt.AlignTop)
        self.main_layout.setContentsMargins(30, 20, 30, 20)
        self.main_layout.setSpacing(20)

        # Show login screen first
        self.show_login()
        self.apply_theme()

    # ------------------ LOGIN SCREEN ------------------ #
    def show_login(self):
        self.clear_layout()

        card = QFrame()
        card.setFrameShape(QFrame.StyledPanel)
        card.setStyleSheet("padding: 25px; border-radius: 15px; background-color: #ffffff;")
        card_layout = QVBoxLayout(card)
        card_layout.setSpacing(15)

        title = QLabel("Welcome to Secure Bank")
        title.setStyleSheet("font-size: 24px; font-weight: bold;")
        title.setAlignment(Qt.AlignCenter)
        card_layout.addWidget(title)

        subtitle = QLabel("Please enter your credentials")
        subtitle.setAlignment(Qt.AlignCenter)
        card_layout.addWidget(subtitle)

        self.user_input = QLineEdit()
        self.user_input.setPlaceholderText("Username")
        self.user_input.setFixedHeight(35)

        self.pass_input = QLineEdit()
        self.pass_input.setPlaceholderText("Password")
        self.pass_input.setEchoMode(QLineEdit.Password)
        self.pass_input.setFixedHeight(35)

        card_layout.addWidget(self.user_input)
        card_layout.addWidget(self.pass_input)

        self.login_btn = QPushButton("Login")
        self.login_btn.setFixedHeight(40)
        self.login_btn.clicked.connect(self.login)
        card_layout.addWidget(self.login_btn)

        theme_btn = QPushButton("Toggle Light/Dark Mode")
        theme_btn.setFixedHeight(35)
        theme_btn.clicked.connect(self.toggle_theme)
        card_layout.addWidget(theme_btn)

        self.main_layout.addWidget(card)

    def login(self):
        if self.user_input.text() == self.username and self.pass_input.text() == self.password:
            self.logged_in = True
            self.show_dashboard()
        else:
            self.show_alert("Error", "Invalid username or password!", error=True)

    def logout(self):
        self.logged_in = False
        self.show_login()

    # ------------------ DASHBOARD ------------------ #
    def show_dashboard(self):
        self.clear_layout()

        card = QFrame()
        card.setFrameShape(QFrame.StyledPanel)
        card.setStyleSheet("padding: 20px; border-radius: 15px; background-color: #ffffff;")
        card_layout = QVBoxLayout(card)
        card_layout.setSpacing(12)

        self.label = QLabel(f"Welcome, {self.username}!\nBalance: ₹{self.balance}")
        self.label.setStyleSheet("font-size: 20px; font-weight: bold;")
        self.label.setAlignment(Qt.AlignCenter)
        card_layout.addWidget(self.label)

        # Action buttons
        buttons = [
            ("Deposit Money", self.deposit),
            ("Withdraw Money", self.withdraw),
            ("Transfer Money", self.transfer),
            ("Check Balance", self.check_balance),
            ("Transaction History", self.show_history),
            ("Reset Account", self.reset_account),
            ("Logout", self.logout)
        ]

        for text, func in buttons:
            btn = QPushButton(text)
            btn.setFixedHeight(40)
            btn.clicked.connect(func)
            card_layout.addWidget(btn)

        # Theme toggle at bottom
        theme_btn = QPushButton("Toggle Light/Dark Mode")
        theme_btn.setFixedHeight(35)
        theme_btn.clicked.connect(self.toggle_theme)
        card_layout.addWidget(theme_btn)

        self.main_layout.addWidget(card)

    # ------------------ BANK FUNCTIONS ------------------ #
    def deposit(self):
        amount, ok = QInputDialog.getInt(self, "Deposit Amount", "Enter amount (₹):", 0, 0)
        if ok and amount > 0:
            self.balance += amount
            self.accounts["Me"] += amount
            self.history.append(f"Deposited: ₹{amount}")
            self.label.setText(f"Welcome, {self.username}!\nBalance: ₹{self.balance}")
            self.show_alert("Deposit", f"Deposited ₹{amount} successfully!")
        elif ok:
            self.show_alert("Error", "Enter a positive amount.", error=True)

    def withdraw(self):
        amount, ok = QInputDialog.getInt(self, "Withdraw Amount", "Enter amount (₹):", 0, 0)
        if ok and 0 < amount <= self.balance:
            self.balance -= amount
            self.accounts["Me"] -= amount
            self.history.append(f"Withdrew: ₹{amount}")
            self.label.setText(f"Welcome, {self.username}!\nBalance: ₹{self.balance}")
            self.show_alert("Withdraw", f"Withdrew ₹{amount} successfully!")
        elif ok:
            self.show_alert("Error", "Insufficient balance!", error=True)

    def transfer(self):
        amount, ok = QInputDialog.getInt(self, "Transfer Amount", "Enter amount (₹):", 0, 0)
        if ok and 0 < amount <= self.balance:
            receiver, ok2 = QInputDialog.getItem(self, "Transfer", "Select recipient:",
                                                 list(self.accounts.keys())[1:], 0, False)
            if ok2:
                self.balance -= amount
                self.accounts["Me"] -= amount
                self.accounts[receiver] += amount
                self.history.append(f"Transferred ₹{amount} to {receiver}")
                self.label.setText(f"Welcome, {self.username}!\nBalance: ₹{self.balance}")
                self.show_alert("Transfer", f"Transferred ₹{amount} to {receiver}")
        elif ok:
            self.show_alert("Error", "Insufficient balance!", error=True)

    def check_balance(self):
        self.show_alert("Balance", f"Your Balance: ₹{self.balance}")

    def show_history(self):
        history_text = "\n".join(self.history) if self.history else "No transactions yet."
        self.show_alert("Transaction History", history_text)

    def reset_account(self):
        self.balance = 0
        self.accounts = {"Me": 0, "Friend": 0, "Family": 0}
        self.history.clear()
        self.label.setText(f"Welcome, {self.username}!\nBalance: ₹{self.balance}")
        self.show_alert("Reset", "Account has been reset.")

    # ------------------ UTILITIES ------------------ #
    def clear_layout(self):
        while self.main_layout.count():
            child = self.main_layout.takeAt(0)
            if child.widget():
                child.widget().deleteLater()

    def toggle_theme(self):
        self.is_dark = not self.is_dark
        self.apply_theme()

    def apply_theme(self):
        if self.is_dark:
            self.setStyleSheet("""
                QMainWindow { background-color: #121212; }
                QLabel { color: #ffffff; }
                QPushButton {
                    background-color: #1DB954;
                    color: white;
                    font-size: 14px;
                    border-radius: 6px;
                    padding: 6px;
                }
                QPushButton:hover { background-color: #1ed760; }
                QLineEdit {
                    background: #2c2c2c;
                    color: white;
                    padding: 5px;
                    border-radius: 6px;
                }
            """)
        else:
            self.setStyleSheet("""
                QMainWindow { background-color: #f0f2f5; }
                QLabel { color: #0d1b2a; }
                QPushButton {
                    background-color: #003366;
                    color: white;
                    font-size: 14px;
                    border-radius: 6px;
                    padding: 6px;
                }
                QPushButton:hover { background-color: #0055a5; }
                QLineEdit {
                    background: white;
                    color: black;
                    padding: 5px;
                    border-radius: 6px;
                }
            """)

    def show_alert(self, title, message, error=False):
        msg = QMessageBox(self)
        msg.setWindowTitle(title)
        msg.setText(message)
        if self.is_dark:
            msg.setStyleSheet("""
                QMessageBox { background-color: #2c2c2c; color: white; }
                QLabel { color: white; }
                QPushButton { background-color: #1DB954; color: white; padding: 5px; }
                QPushButton:hover { background-color: #1ed760; }
            """)
        if error:
            msg.setIcon(QMessageBox.Warning)
        else:
            msg.setIcon(QMessageBox.Information)
        msg.exec_()


if __name__ == "__main__":
    app = QApplication(sys.argv)
    window = BankApp()
    window.show()
    sys.exit(app.exec_())